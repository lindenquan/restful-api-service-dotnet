@page "/place-order"
@using Adapters.ApiClient.V1
@using DTOs.V1
@using Web.Services
@inject OrderService OrderService
@inject NavigationManager Navigation

<PageTitle>Place Prescription Order</PageTitle>

<div class="container mt-4">
    <h1>Place Prescription Order</h1>
    <p class="text-muted">Fill out the form below to place a new prescription order.</p>

    @if (successMessage != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <strong>Success!</strong> @successMessage
            <button type="button" class="btn-close" @onclick="() => successMessage = null"></button>
        </div>
    }

    @if (errorMessage != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <strong>Error!</strong> @errorMessage
            <button type="button" class="btn-close" @onclick="() => errorMessage = null"></button>
        </div>
    }

    <div class="card">
        <div class="card-body">
            <EditForm Model="@orderRequest" OnValidSubmit="@HandleSubmit">
                <DataAnnotationsValidator />
                
                <div class="mb-3">
                    <label for="patientId" class="form-label">Patient ID</label>
                    <InputNumber id="patientId" class="form-control" @bind-Value="orderRequest.PatientId" />
                    <div class="form-text">Enter the patient's ID number</div>
                    <ValidationMessage For="@(() => orderRequest.PatientId)" />
                </div>

                <div class="mb-3">
                    <label for="prescriptionId" class="form-label">Prescription ID</label>
                    <InputNumber id="prescriptionId" class="form-control" @bind-Value="orderRequest.PrescriptionId" />
                    <div class="form-text">Enter the prescription ID to fulfill</div>
                    <ValidationMessage For="@(() => orderRequest.PrescriptionId)" />
                </div>

                <div class="mb-3">
                    <label for="notes" class="form-label">Notes (Optional)</label>
                    <InputTextArea id="notes" class="form-control" rows="3" @bind-Value="orderRequest.Notes" 
                                   placeholder="Add any special instructions or notes..." />
                    <ValidationMessage For="@(() => orderRequest.Notes)" />
                </div>

                <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-primary" disabled="@isSubmitting">
                        @if (isSubmitting)
                        {
                            <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                            <span>Placing Order...</span>
                        }
                        else
                        {
                            <span>Place Order</span>
                        }
                    </button>
                    <button type="button" class="btn btn-secondary" @onclick="HandleCancel" disabled="@isSubmitting">
                        Cancel
                    </button>
                </div>
            </EditForm>
        </div>
    </div>

    <div class="mt-4">
        <h5>Instructions:</h5>
        <ul>
            <li>Patient ID and Prescription ID are required</li>
            <li>Make sure the prescription is valid and not expired</li>
            <li>Orders will be created with "Pending" status</li>
            <li>You can track your order status on the <a href="/order-status">Order Status</a> page</li>
        </ul>
    </div>
</div>

@code {
    private CreateOrderRequestModel orderRequest = new();
    private bool isSubmitting = false;
    private string? successMessage;
    private string? errorMessage;

    private async Task HandleSubmit()
    {
        isSubmitting = true;
        errorMessage = null;
        successMessage = null;

        try
        {
            var request = new CreateOrderRequest(
                PatientId: orderRequest.PatientId,
                PrescriptionId: orderRequest.PrescriptionId,
                Notes: orderRequest.Notes
            );

            // Validate using service
            var validationError = OrderService.ValidateCreateOrderRequest(request);
            if (validationError != null)
            {
                errorMessage = validationError;
                return;
            }

            var createdOrder = await OrderService.CreateOrderAsync(request);
            successMessage = $"Order #{createdOrder.Id} placed successfully! Status: {createdOrder.Status}";
            
            // Reset form
            orderRequest = new();
            
            // Navigate to order status page after 2 seconds
            await Task.Delay(2000);
            Navigation.NavigateTo($"/order-status/{createdOrder.Id}");
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to place order: {ex.Message}";
        }
        finally
        {
            isSubmitting = false;
        }
    }

    private void HandleCancel()
    {
        Navigation.NavigateTo("/orders");
    }

    // Model for form binding with validation
    private class CreateOrderRequestModel
    {
        public int PatientId { get; set; }
        public int PrescriptionId { get; set; }
        public string? Notes { get; set; }
    }
}

