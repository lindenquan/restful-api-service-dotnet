# Docker Compose for Local Development and Testing
#
# Usage:
#   Start MongoDB + Redis only:
#     docker compose up -d mongodb redis
#
#   Start all services (MongoDB + Redis + API):
#     docker compose up -d
#
#   Stop all services:
#     docker compose down
#
# Services:
#   - mongodb: MongoDB database (port 27017)
#   - redis: Redis cache (port 6379)
#   - api: Prescription Order API service (port 5000)

services:
  mongodb:
    image: mongo:8.0
    container_name: prescription-mongodb
    ports:
      - "27017:27017"
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_INITDB_ROOT_USERNAME}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_INITDB_ROOT_PASSWORD}
      MONGO_INITDB_DATABASE: ${MONGO_DATABASE}
    volumes:
      - mongodb_data:/data/db
    healthcheck:
      test: ["CMD", "mongosh", "--username", "${MONGO_INITDB_ROOT_USERNAME}", "--password", "${MONGO_INITDB_ROOT_PASSWORD}", "--eval", "db.adminCommand('ping')"]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 10s

  redis:
    image: redis:7.4-alpine
    container_name: prescription-redis
    ports:
      - "${REDIS_PORT}:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 5s

  api:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: prescription-api
    ports:
      - "8080:8080"
    environment:
      ASPNETCORE_ENVIRONMENT: local
      # Override Kestrel endpoint URL (base appsettings.json has localhost:5000)
      Kestrel__Endpoints__Http__Url: http://+:8080
      MongoDB__ConnectionString: mongodb://mongodb:27017
      MongoDB__Username: ${MongoDB__Username}
      MongoDB__Password: ${MongoDB__Password}
      MongoDB__DatabaseName: ${MONGO_DATABASE}
      Cache__L2__ConnectionString: redis:${REDIS_PORT}
      Cache__L2__Enabled: "true"
    depends_on:
      mongodb:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

volumes:
  mongodb_data:

