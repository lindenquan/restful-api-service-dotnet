# Docker Compose for Local Development and Testing
#
# Usage:
#   Start MongoDB + Redis only:
#     docker compose up -d mongodb redis
#
#   Start all services (MongoDB + Redis + API):
#     docker compose up -d
#
#   Run database migrations only:
#     docker compose up db-migrate
#
#   Stop all services:
#     docker compose down
#
# Services:
#   - mongodb: MongoDB database (port 27017)
#   - redis: Redis cache (port 6379)
#   - db-migrate: Database initialization (creates collections and indexes)
#   - api: Prescription Order API service (port 8080)

services:
  mongodb:
    image: mongo:8.0
    container_name: prescription-mongodb
    ports:
      - "27017:27017"
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_INITDB_ROOT_USERNAME}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_INITDB_ROOT_PASSWORD}
      MONGO_INITDB_DATABASE: ${MONGO_DATABASE}
    volumes:
      - mongodb_data:/data/db
      - ./docker/mongodb-keyfile:/etc/mongodb-keyfile-source:ro
      - ./docker/mongodb-entrypoint.sh:/docker-entrypoint-initdb.d/mongodb-entrypoint.sh:ro
    # Run as a single-node replica set to support transactions
    entrypoint: ["/bin/bash", "-c", "cp /etc/mongodb-keyfile-source /tmp/mongodb-keyfile && chmod 400 /tmp/mongodb-keyfile && chown mongodb:mongodb /tmp/mongodb-keyfile && exec docker-entrypoint.sh --replSet rs0 --bind_ip_all --keyFile /tmp/mongodb-keyfile"]
    healthcheck:
      test: ["CMD", "mongosh", "--username", "${MONGO_INITDB_ROOT_USERNAME}", "--password", "${MONGO_INITDB_ROOT_PASSWORD}", "--eval", "try { rs.status().ok } catch(e) { rs.initiate({_id:'rs0',members:[{_id:0,host:'mongodb:27017'}]}).ok }"]
      interval: 5s
      timeout: 10s
      retries: 10
      start_period: 15s

  redis:
    image: redis:7.4-alpine
    container_name: prescription-redis
    ports:
      - "${REDIS_PORT}:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 5s

  db-migrate:
    build:
      context: .
      dockerfile: tools/DatabaseMigrations/Dockerfile
    container_name: prescription-db-migrate
    environment:
      DOTNET_ENVIRONMENT: Production
      MongoDB__ConnectionString: mongodb://mongodb:27017
      MongoDB__Username: ${MongoDB__Username}
      MongoDB__Password: ${MongoDB__Password}
      MongoDB__DatabaseName: ${MONGO_DATABASE}
    depends_on:
      mongodb:
        condition: service_healthy
    # Run once and exit - this is an init container pattern
    restart: "no"

  api:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: prescription-api
    ports:
      - "8080:8080"
    environment:
      ASPNETCORE_ENVIRONMENT: local
      Kestrel__Endpoints__Http__Url: http://+:8080
      MongoDB__ConnectionString: mongodb://mongodb:27017
      MongoDB__Username: ${MongoDB__Username}
      MongoDB__Password: ${MongoDB__Password}
      MongoDB__DatabaseName: ${MONGO_DATABASE}
      Cache__L2__ConnectionString: redis:${REDIS_PORT}
      Cache__L2__Enabled: "true"
      # Root admin initialization
      RootAdmin__InitialApiKey: ${RootAdmin__InitialApiKey}
      RootAdmin__EnableAutoCreate: "true"
    depends_on:
      mongodb:
        condition: service_healthy
      redis:
        condition: service_healthy
      db-migrate:
        condition: service_completed_successfully
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

volumes:
  mongodb_data:

